# =============================================================================
# AI Dev Base - Docker Compose (Basis-Konfiguration)
# =============================================================================
# Usage:
#   ./dev.sh start              # Ohne Docker Socket (sicher)
#   ./dev.sh start --docker     # Mit Docker Socket + Proxy
#   ./dev.sh start --firewall   # Mit Netzwerk-Firewall
#   ./dev.sh start --docker --firewall  # Beides kombiniert
#
# Configuration:
#   Copy .env.example to .env and adjust paths for your system.
# =============================================================================

# -----------------------------------------------------------------------------
# Shared Configuration (YAML Anchors)
# -----------------------------------------------------------------------------
x-common-volumes: &common-volumes
  # AI Agent configs & credentials
  - claude-config:/home/dev/.claude
  - gemini-config:/home/dev/.gemini
  - codex-config:/home/dev/.codex
  - opencode-config:/home/dev/.config/opencode
  - gh-config:/home/dev/.config/gh
  # Cache
  - uv-cache:/home/dev/.cache/uv
  # Host configs (read-only)
  - ~/.ssh:/home/dev/.ssh:ro
  - ~/.gitconfig:/home/dev/.gitconfig:ro
  # Seed configs (read-only)
  - ./config/claude:/home/dev/.claude_seed:ro
  - ./config/gemini:/home/dev/.gemini_seed:ro
  - ./config/opencode:/home/dev/.opencode_seed:ro
  # Projects directory
  - ${CODE_DIR:?Please set CODE_DIR in .env or environment}:/home/dev/projects

x-common-environment: &common-environment
  TZ: ${TZ:-Europe/Berlin}
  UV_LINK_MODE: copy
  LOCAL_ENDPOINT: ${LOCAL_ENDPOINT:-http://ai-station:11434/v1}

x-resource-limits: &resource-limits
  resources:
    limits:
      cpus: '${CPU_LIMIT:-6}'
      memory: ${MEMORY_LIMIT:-12G}

services:
  # ---------------------------------------------------------------------------
  # Main development container
  # ---------------------------------------------------------------------------
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: ai-dev-base:latest
    container_name: ai-dev
    stdin_open: true
    tty: true
    networks:
      - ai-dev-network
    volumes: *common-volumes
    environment:
      <<: *common-environment
      MCP_GATEWAY_URL: http://mcp-gateway:8811/
      ENABLE_FIREWALL: ${ENABLE_FIREWALL:-false}
    cap_add:
      - NET_ADMIN
    deploy:
      <<: *resource-limits
      resources:
        limits:
          cpus: '${CPU_LIMIT:-6}'
          memory: ${MEMORY_LIMIT:-12G}
        reservations:
          cpus: '${CPU_RESERVATION:-2}'
          memory: ${MEMORY_RESERVATION:-4G}
    working_dir: /home/dev/projects

  # ---------------------------------------------------------------------------
  # OAuth authentication container (uses host network)
  # ---------------------------------------------------------------------------
  dev-auth:
    image: ai-dev-base:latest
    container_name: ai-dev-auth
    stdin_open: true
    tty: true
    profiles:
      - auth
    network_mode: "host"
    volumes: *common-volumes
    environment:
      <<: *common-environment
      MCP_GATEWAY_URL: http://localhost:8811/
    deploy: *resource-limits
    working_dir: /home/dev/projects

networks:
  ai-dev-network:
    external: true
    name: ai-dev-network

volumes:
  claude-config:
    name: ai-dev-claude-config
  gemini-config:
    name: ai-dev-gemini-config
  codex-config:
    name: ai-dev-codex-config
  opencode-config:
    name: ai-dev-opencode-config
  gh-config:
    name: ai-dev-gh-config
  uv-cache:
    name: ai-dev-uv-cache
